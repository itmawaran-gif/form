<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAWARAN co</title>

<style>
body{
  font-family: Arial;
  background:#f5f5f5;
  margin:0;
  padding:10px;
}
.container{
  max-width:420px;
  margin:auto;
  background:#fff;
  padding:15px;
  border-radius:8px;
}
h2{text-align:center}
input,select,textarea,button{
  width:100%;
  padding:10px;
  margin-top:8px;
  font-size:16px;
}
button{
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:5px;
}
.loading{text-align:center;color:red}
</style>
</head>

<body>

<div class="container" id="loginBox">
  <h2>تسجيل المندوب</h2>
  <input id="repName" placeholder="اسم المندوب الثلاثي" required>
  <input id="city" placeholder="المدينة" required>
  <button onclick="saveRep()">دخول</button>
</div>

<div class="container" id="formBox" style="display:none">
  <h2>MAWARAN co</h2>

  <select id="useOil" required>
    <option value="">هل يستخدم زيت؟</option>
    <option value="نعم">نعم</option>
    <option value="لا">لا</option>
  </select>

  <input id="tradeName" placeholder="الاسم التجاري" required>
  <input id="ownerName" placeholder="اسم المالك" required>
  <input id="address" placeholder="العنوان" required>
  <input id="phone" type="tel" inputmode="numeric" placeholder="رقم الهاتف" required>

  <select id="category" required>
    <option value="">اختر الفئة</option>
  </select>

  <textarea id="note" placeholder="ملاحظة" required></textarea>

  <select id="rating" required>
    <option value="">التقييم</option>
    <option value="1">⭐</option>
    <option value="2">⭐⭐</option>
    <option value="3">⭐⭐⭐</option>
    <option value="4">⭐⭐⭐⭐</option>
    <option value="5">⭐⭐⭐⭐⭐</option>
  </select>

  <input id="visitDays" type="number" placeholder="أيام الزيارة" required>

  <input id="oilType" placeholder="نوع الزيت" required>
  <input id="oilGrade" placeholder="درجة الزيت" required>

  <select id="distance" required>
    <option value="">المسافة</option>
    <option value="3 كم">3 كم</option>
    <option value="5 كم">5 كم</option>
    <option value="10 كم">10 كم</option>
    <option value="15 كم">15 كم</option>
  </select>

  <input id="price" type="number" placeholder="سعر اللتر" required>

  <input id="image" type="file" accept="image/*" capture="environment" required>

  <button id="sendBtn" onclick="sendData()">إرسال</button>
  <div class="loading" id="loading"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypaWCWNYGXtNJz5a0EqLJ3IYs31OZz_SQ_hNFsbAi-PyZqlhhDA848lEDOPPOY3ko0NA/exec";

function saveRep(){
  if(!repName.value || !city.value) return alert("الحقول مطلوبة");
  localStorage.setItem("repName",repName.value);
  localStorage.setItem("city",city.value);
  showForm();
}

function showForm(){
  loginBox.style.display="none";
  formBox.style.display="block";
  loadCategories();
}

function loadCategories(){
  fetch(SCRIPT_URL+"?action=categories")
  .then(r=>r.json())
  .then(d=>{
    category.innerHTML='<option value="">اختر الفئة</option>';
    d.forEach(c=>{
      let o=document.createElement("option");
      o.value=c;o.textContent=c;
      category.appendChild(o);
    });
  });
}

function sendData(){
  const img=image.files[0];
  if(!img) return alert("الصورة مطلوبة");

  const r=new FileReader();
  r.onloadend=function(){
    const fd=new FormData();
    fd.append("rep",localStorage.getItem("repName"));
    fd.append("city",localStorage.getItem("city"));
    fd.append("trade",tradeName.value);
    fd.append("owner",ownerName.value);
    fd.append("address",address.value);
    fd.append("phone",phone.value);
    fd.append("category",category.value);
    fd.append("note",note.value);
    fd.append("rating",rating.value);
    fd.append("visitDays",visitDays.value);
    fd.append("useOil",useOil.value);
    fd.append("oilType",oilType.value);
    fd.append("oilGrade",oilGrade.value);
    fd.append("distance",distance.value);
    fd.append("price",price.value);
    fd.append("imageBase64",r.result);

    navigator.geolocation.getCurrentPosition(pos=>{
      fd.append("lat",pos.coords.latitude);
      fd.append("lng",pos.coords.longitude);
      fetch(SCRIPT_URL,{method:"POST",body:fd})
      .then(()=>{alert("تم الإرسال");location.reload();});
    });
  };
  r.readAsDataURL(img);
}

if(localStorage.getItem("repName")) showForm();
</script>

</body>
</html>
